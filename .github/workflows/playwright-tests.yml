name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: Setup display
        run: |
          # 设置虚拟显示器
          export DISPLAY=:99
          sudo Xvfb -ac :99 -screen 0 1280x1024x24 > /dev/null 2>&1 &
          echo "已启动虚拟显示"
          
      - name: Install dependencies
        run: npm ci
      
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ hashFiles('**/package-lock.json') }}
          
      - name: Install Playwright browsers
        run: npx playwright install --with-deps
        
      - name: Install Electron dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-0 \
            libgbm-dev \
            libatspi2.0-0 \
            libatk1.0-0 \
            libasound2-dev \
            libsecret-1-dev \
            libdrm-dev \
            libgconf-2-4 \
            libnss3-dev
      
      - name: Verify Electron
        run: |
          echo "验证Electron环境..."
          npx electron --version
          echo "Electron版本检查完成"
      
      - name: Run tests with verbose output
        env:
          NODE_ENV: test
          CI: true
          DEBUG: pw:api,pw:browser*,electron*
          ELECTRON_ENABLE_LOGGING: true
        run: npm run test:ci
      
      - name: List test directories
        if: always()
        run: |
          echo "测试目录内容:"
          ls -la tests/
          echo "测试数据目录内容:"
          ls -la tests/mock-data/ || echo "mock-data目录不存在"
          echo "测试报告目录内容:"
          ls -la playwright-report/ || echo "playwright-report目录不存在"
        
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30 